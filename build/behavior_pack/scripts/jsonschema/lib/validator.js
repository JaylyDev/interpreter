import e from"./attribute.js";import*as t from"./helpers.js";import{scan as s}from"./scan.js";var r=t.ValidatorResult,i=t.ValidatorResultError,a=t.SchemaError,o=t.SchemaContext;const h=["","","","","","","","","","%09","%0A","","","%0D","","","","","","","","","","","","","","","","","","","%20","","%22","","","","","%27","","","","","","","","","","","","","","","","","","","","","%3C","","%3E","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","%5C","","%5E","","%60","","","","","","","","","","","","","","","","","","","","","","","","","","","%7B","%7C","%7D"];const n=/^[a-z0-9.+-]+:/i,c=/^\/\/[^@/]+@[^@/]+/,l=new Set(["javascript","javascript:"]),u=new Set(["javascript","javascript:"]),f=new Set(["http","http:","https","https:","ftp","ftp:","gopher","gopher:","file","file:","ws","ws:","wss","wss:"]),p=/^(\/\/?(?!\/)[^?\s]*)(\?[^\s]*)?$/,m=TypeError;class d{static parse(e,t,s){!function(e,t){if("string"!=typeof e)throw new m(t,"string",e)}(e,"url");let r=!1,i=!1,a=-1,o=-1,d="",y=0;for(let t=0,s=!1,h=!1;t<e.length;++t){const n=e.charCodeAt(t),c=n<33||160===n||65279===n;if(-1===a){if(c)continue;y=a=t}else s?c||(o=-1,s=!1):c&&(o=t,s=!0);if(h)r||35!==n||(r=!0);else switch(n){case 64:i=!0;break;case 35:r=!0;case 63:h=!0;break;case 92:t-y>0&&(d+=e.slice(y,t)),d+="/",y=t+1}}if(-1!==a&&(y===a?d=-1===o?0===a?e:e.slice(a):e.slice(a,o):-1===o&&y<e.length?d+=e.slice(y):-1!==o&&y<o&&(d+=e.slice(y,o))),!s&&!r&&!i){const e=p.exec(d);if(e)return this.path=d,this.href=d,this.pathname=e[1],e[2]?(this.search=e[2],this.query=t?querystring.parse(this.search.slice(1)):this.search.slice(1)):t&&(this.search=null,this.query=ObjectCreate(null)),this}let v,b,w=n.exec(d);if(w&&(w=w[0],v=w.toLowerCase(),this.protocol=v,d=d.slice(w.length)),(s||w||c.test(d))&&(b=47===d.charCodeAt(0)&&47===d.charCodeAt(1),!b||w&&u.has(v)||(d=d.slice(2),this.slashes=!0)),!u.has(v)&&(b||w&&!f.has(w))){let t=-1,s=-1,r=-1;for(let e=0;e<d.length;++e){switch(d.charCodeAt(e)){case 9:case 10:case 13:case 32:case 34:case 37:case 39:case 59:case 60:case 62:case 92:case 94:case 96:case 123:case 124:case 125:-1===r&&(r=e);break;case 35:case 47:case 63:-1===r&&(r=e),t=e;break;case 64:s=e,r=-1}if(-1!==t)break}a=0,-1!==s&&(this.auth=decodeURIComponent(d.slice(0,s)),a=s+1),-1===r?(this.host=d.slice(a),d=""):(this.host=d.slice(a,r),d=d.slice(r)),this.parseHost(),"string"!=typeof this.hostname&&(this.hostname="");const i=this.hostname,o=isIpv6Hostname(i);if(o||(d=getHostname(this,d,i)),this.hostname.length>255?this.hostname="":this.hostname=this.hostname.toLowerCase(),""!==this.hostname)if(o){if(forbiddenHostCharsIpv6.test(this.hostname))throw new ERR_INVALID_URL(e)}else if(this.hostname=toASCII(this.hostname,!0),""===this.hostname||forbiddenHostChars.test(this.hostname))throw new ERR_INVALID_URL(e);const h=this.port?":"+this.port:"",n=this.hostname||"";this.host=n+h,o&&(this.hostname=this.hostname.slice(1,-1),"/"!==d[0]&&(d="/"+d))}l.has(v)||(d=function(e){let t="",s=0;for(let r=0;r<e.length;++r){const i=h[e.charCodeAt(r)];i&&(r>s&&(t+=e.slice(s,r)),t+=i,s=r+1)}return 0===s?e:(s<e.length&&(t+=e.slice(s)),t)}(d));let g=-1,S=-1;for(let e=0;e<d.length;++e){const t=d.charCodeAt(e);if(35===t){this.hash=d.slice(e),S=e;break}63===t&&-1===g&&(g=e)}-1!==g?(-1===S?(this.search=d.slice(g),this.query=d.slice(g+1)):(this.search=d.slice(g,S),this.query=d.slice(g+1,S)),t&&(this.query=querystring.parse(this.query))):t&&(this.search=null,this.query=ObjectCreate(null));const A=-1!==g&&(-1===S||g<S)?g:S;if(-1===A?d.length>0&&(this.pathname=d):A>0&&(this.pathname=d.slice(0,A)),f.has(v)&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){const e=this.pathname||"",t=this.search||"";this.path=e+t}return this}static resolve(e,t){const s=e+t;if("resolve:"===s.protocol){const{pathname:e,search:t,hash:r}=s;return e+t+r}return s.toString()}}function y(){this.customFormats=Object.create(y.prototype.customFormats),this.schemas={},this.unresolvedRefs=[],this.types=Object.create(b),this.attributes=Object.create(e.validators)}function v(e){var t="string"==typeof e?e:e.$ref;return"string"==typeof t&&t}y.prototype.customFormats={},y.prototype.schemas=null,y.prototype.types=null,y.prototype.attributes=null,y.prototype.unresolvedRefs=null,y.prototype.addSchema=function(e,t){var r=this;if(!e)return null;var i=s(t||"/",e),a=t||e.$id||e.id;for(var o in i.id)this.schemas[o]=i.id[o];for(var o in i.ref)this.unresolvedRefs.push(o);return this.unresolvedRefs=this.unresolvedRefs.filter((function(e){return void 0===r.schemas[e]})),this.schemas[a]},y.prototype.addSubSchemaArray=function(e,t){if(Array.isArray(t))for(var s=0;s<t.length;s++)this.addSubSchema(e,t[s])},y.prototype.addSubSchemaObject=function(e,t){if(t&&"object"==typeof t)for(var s in t)this.addSubSchema(e,t[s])},y.prototype.setSchemas=function(e){this.schemas=e},y.prototype.getSchema=function(e){return this.schemas[e]},y.prototype.validate=function(e,t,h,n){if("boolean"!=typeof t&&"object"!=typeof t||null===t)throw new a("Expected `schema` to be an object or boolean");h||(h={});var c,l=t.$id||t.id,u=d.resolve(h.base||"/",l||"");if(!n){(n=new o(t,h,[],u,Object.create(this.schemas))).schemas[u]||(n.schemas[u]=t);var f=s(u,t);for(var p in f.id){var m=f.id[p];n.schemas[p]=m}}if(h.required&&void 0===e)return(c=new r(e,t,h,n)).addError("is required, but is undefined"),c;if(!(c=this.validateSchema(e,t,h,n)))throw new Error("Result undefined");if(h.throwAll&&c.errors.length)throw new i(c);return c},y.prototype.validateSchema=function(s,i,h,n){var c=new r(s,i,h,n);if("boolean"==typeof i)!0===i?i={}:!1===i&&(i={type:[]});else if(!i)throw new Error("schema is undefined");if(i.extends)if(Array.isArray(i.extends)){var l={schema:i,ctx:n};i.extends.forEach(this.schemaTraverser.bind(this,l)),i=l.schema,l.schema=null,l.ctx=null,l=null}else i=t.deepMerge(i,this.superResolve(i.extends,n));var u=v(i);if(u){var f=this.resolve(i,u,n),p=new o(f.subschema,h,n.path,f.switchSchema,n.schemas);return this.validateSchema(s,f.subschema,h,p)}var m=h&&h.skipAttributes||[];for(var d in i)if(!e.ignoreProperties[d]&&m.indexOf(d)<0){var y=null,b=this.attributes[d];if(b)y=b.call(this,s,i,h,n);else if(!1===h.allowUnknownAttributes)throw new a("Unsupported attribute: "+d,i);y&&c.importErrors(y)}if("function"==typeof h.rewrite){var w=h.rewrite.call(this,s,i,h,n);c.instance=w}return c},y.prototype.schemaTraverser=function(e,s){e.schema=t.deepMerge(e.schema,this.superResolve(s,e.ctx))},y.prototype.superResolve=function(e,t){var s=v(e);return s?this.resolve(e,s,t).subschema:e},y.prototype.resolve=function(e,s,r){if(s=r.resolve(s),r.schemas[s])return{subschema:r.schemas[s],switchSchema:s};var i=d.parse(s),o=i&&i.hash,h=o&&o.length&&s.substr(0,s.length-o.length);if(!h||!r.schemas[h])throw new a("no such schema <"+s+">",e);var n=t.objectGetPath(r.schemas[h],o.substr(1));if(void 0===n)throw new a("no such schema "+o+" located in <"+h+">",e);return{subschema:n,switchSchema:s}},y.prototype.testType=function(e,t,s,r,i){if(void 0!==i){if(null===i)throw new a('Unexpected null in "type" keyword');if("function"==typeof this.types[i])return this.types[i].call(this,e);if(i&&"object"==typeof i){var o=this.validateSchema(e,i,s,r);return void 0===o||!(o&&o.errors.length)}return!0}};var b=y.prototype.types={};b.string=function(e){return"string"==typeof e},b.number=function(e){return"number"==typeof e&&isFinite(e)},b.integer=function(e){return"number"==typeof e&&e%1==0},b.boolean=function(e){return"boolean"==typeof e},b.array=function(e){return Array.isArray(e)},b.null=function(e){return null===e},b.date=function(e){return e instanceof Date},b.any=function(e){return!0},b.object=function(e){return e&&"object"==typeof e&&!Array.isArray(e)&&!(e instanceof Date)};export{y as Validator};